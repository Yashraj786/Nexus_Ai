<div class="min-h-screen bg-white">
  <div class="max-w-2xl mx-auto px-6 py-12">
    
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
            <i data-lucide="settings" class="w-6 h-6 text-orange-600"></i>
          </div>
          <h1 class="text-3xl font-bold text-neutral-900">API Configuration</h1>
        </div>
        <%= link_to root_path, class: "flex items-center gap-2 px-4 py-2 rounded-lg bg-neutral-100 hover:bg-neutral-200 text-neutral-900 transition-colors" do %>
          <i data-lucide="arrow-left" class="w-4 h-4"></i>
          Back
        <% end %>
      </div>
      <p class="text-neutral-600">Configure your AI provider to start chatting with personas</p>
    </div>

    <!-- Status Indicator -->
    <div class="mb-8 p-6 rounded-lg border-2 <%= @api_configured ? 'border-green-200 bg-green-50' : 'border-orange-200 bg-orange-50' %>">
      <div class="flex items-start gap-4">
        <div class="flex-shrink-0 pt-1">
          <% if @api_configured %>
            <i data-lucide="check-circle-2" class="w-6 h-6 text-green-600"></i>
          <% else %>
            <i data-lucide="alert-circle" class="w-6 h-6 text-orange-600"></i>
          <% end %>
        </div>
        <div class="flex-1">
          <% if @api_configured %>
            <h3 class="font-bold text-green-900 mb-1">✓ API Key Configured</h3>
            <p class="text-sm text-green-800 mb-3">Your API configuration is active and ready to use</p>
            <div class="space-y-2 text-sm text-green-800">
              <p><strong>Provider:</strong> <span class="font-mono bg-white/50 px-2 py-1 rounded"><%= @user.api_provider.upcase %></span></p>
              <p><strong>Model:</strong> <span class="font-mono bg-white/50 px-2 py-1 rounded"><%= @user.api_model_name %></span></p>
              <p><strong>Last Updated:</strong> <%= @user.api_configured_at&.strftime("%B %d, %Y at %l:%M %p") || "N/A" %></p>
            </div>
          <% else %>
            <h3 class="font-bold text-orange-900 mb-1">⚠ No API Key Configured</h3>
            <p class="text-sm text-orange-800">Configure an API provider below to start using Nexus AI and chat with personas</p>
          <% end %>
        </div>
      </div>
    </div>

    <!-- API Configuration Form -->
    <div class="bg-white border border-neutral-200 rounded-lg p-8">
      <h2 class="text-xl font-bold text-neutral-900 mb-6">Configure Your API Provider</h2>

      <!-- Error Messages -->
      <div id="api-form-errors" class="hidden mb-6 p-4 rounded-lg bg-red-50 border border-red-200">
        <div class="flex items-start gap-3">
          <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"></i>
          <div id="error-message-text" class="text-sm text-red-700"></div>
        </div>
      </div>

      <!-- Success Message -->
      <div id="api-success-message" class="hidden mb-6 p-4 rounded-lg bg-green-50 border border-green-200">
        <div class="flex items-start gap-3">
          <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"></i>
          <div class="text-sm text-green-700">
            <p class="font-bold mb-2">✓ API Configuration Saved!</p>
            <p class="mb-3">Your API key has been saved successfully. You can now start chatting!</p>
            <%= link_to "Go to Chat →", new_chat_session_path, class: "inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium" %>
          </div>
        </div>
      </div>

      <form id="api-settings-form" data-controller="api-settings" data-api-settings-target="form" data-action="submit->api-settings#submitForm" class="space-y-6">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">

        <!-- Provider Selection -->
        <div>
          <label for="api_provider" class="block text-sm font-semibold text-neutral-900 mb-2">
            AI Provider <span class="text-red-500">*</span>
          </label>
          <select id="api_provider" name="user[api_provider]" class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-colors bg-white text-neutral-900" required>
            <option value="">-- Select Your AI Provider --</option>
            <option value="openai" <%= 'selected' if @user.api_provider == 'openai' %>>OpenAI (GPT-4, GPT-3.5-turbo)</option>
            <option value="anthropic" <%= 'selected' if @user.api_provider == 'anthropic' %>>Anthropic (Claude 3)</option>
            <option value="gemini" <%= 'selected' if @user.api_provider == 'gemini' %>>Google Gemini</option>
            <option value="ollama" <%= 'selected' if @user.api_provider == 'ollama' %>>Ollama (Local)</option>
            <option value="custom" <%= 'selected' if @user.api_provider == 'custom' %>>Custom API</option>
          </select>
          <p class="text-xs text-neutral-600 mt-2">Choose which AI provider you want to use</p>
        </div>

        <!-- Model Name -->
        <div>
          <label for="api_model_name" class="block text-sm font-semibold text-neutral-900 mb-2">
            Model Name <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="api_model_name" 
            name="user[api_model_name]" 
            placeholder="e.g., gpt-4, gpt-3.5-turbo, claude-3-opus-20240229, gemini-1.5-flash"
            value="<%= @user.api_model_name %>" 
            class="w-full px-4 py-3 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-colors bg-white text-neutral-900"
            required />
          <p class="text-xs text-neutral-600 mt-2">The specific model version to use (check your provider's documentation)</p>
        </div>

        <!-- API Key -->
        <div>
          <label for="api_key" class="block text-sm font-semibold text-neutral-900 mb-2">
            API Key <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <input 
              type="password" 
              id="api_key" 
              name="user[encrypted_api_key]" 
              placeholder="Your API key (keep it secret!)"
              class="w-full px-4 py-3 pr-12 border border-neutral-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent transition-colors bg-white text-neutral-900"
              required />
          <button 
            type="button" 
            id="toggle-api-key" 
            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-neutral-600 hover:text-neutral-900 transition-colors"
            data-api-settings-target="apiKey"
            data-action="click->api-settings#toggleApiKey">
              <i data-lucide="eye" class="w-5 h-5"></i>
            </button>
          </div>
          <p class="text-xs text-neutral-600 mt-2">Your API key is encrypted and never shared. You can get one from your provider's website</p>
        </div>

        <!-- Helpful Links -->
        <div class="p-4 rounded-lg bg-neutral-50 border border-neutral-200">
          <p class="text-sm font-semibold text-neutral-900 mb-3">Need help getting your API key?</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <a href="https://platform.openai.com/account/api-keys" target="_blank" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white hover:bg-neutral-100 border border-neutral-200 transition-colors text-sm text-neutral-700 hover:text-neutral-900">
              <i data-lucide="external-link" class="w-4 h-4"></i>
              OpenAI Keys
            </a>
            <a href="https://console.anthropic.com/" target="_blank" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white hover:bg-neutral-100 border border-neutral-200 transition-colors text-sm text-neutral-700 hover:text-neutral-900">
              <i data-lucide="external-link" class="w-4 h-4"></i>
              Anthropic Console
            </a>
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white hover:bg-neutral-100 border border-neutral-200 transition-colors text-sm text-neutral-700 hover:text-neutral-900">
              <i data-lucide="external-link" class="w-4 h-4"></i>
              Google AI Studio
            </a>
            <a href="https://ollama.ai" target="_blank" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white hover:bg-neutral-100 border border-neutral-200 transition-colors text-sm text-neutral-700 hover:text-neutral-900">
              <i data-lucide="external-link" class="w-4 h-4"></i>
              Ollama Setup
            </a>
          </div>
        </div>

        <!-- Buttons -->
        <div class="flex gap-3 pt-4 border-t border-neutral-200">
          <button 
            type="submit" 
            id="save-api-btn"
            data-api-settings-target="saveButton"
            class="flex items-center justify-center gap-2 px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium">
            <i data-lucide="save" class="w-4 h-4"></i>
            <span data-api-settings-target="saveButtonText">Save API Configuration</span>
            <span data-api-settings-target="saveSpinner" class="hidden animate-spin">
              <i data-lucide="loader" class="w-4 h-4"></i>
            </span>
          </button>

          <button 
            type="button" 
            id="test-api-btn"
            data-api-settings-target="testButton"
            class="flex items-center justify-center gap-2 px-6 py-3 border border-neutral-300 text-neutral-700 rounded-lg hover:bg-neutral-50 transition-colors font-medium"
            data-action="click->api-settings#testConnection"
            <%= 'disabled' unless @api_configured %>>
            <i data-lucide="zap" class="w-4 h-4"></i>
            <span>Test Connection</span>
          </button>

          <% if @api_configured %>
            <%= button_to settings_clear_api_key_path, method: :delete, class: "flex items-center justify-center gap-2 px-6 py-3 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors font-medium", data: { confirm: "Clear your API configuration? You won't be able to use the chat until you reconfigure." } do %>
              <i data-lucide="trash-2" class="w-4 h-4"></i>
              <span>Clear Configuration</span>
            <% end %>
          <% end %>
        </div>
      </form>
    </div>

    <!-- Info Box -->
    <div class="mt-8 p-6 rounded-lg bg-blue-50 border border-blue-200">
      <div class="flex items-start gap-3">
        <i data-lucide="info" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"></i>
        <div class="text-sm text-blue-900">
          <p class="font-bold mb-2">How it works:</p>
          <ol class="list-decimal list-inside space-y-1">
            <li>Select your AI provider above</li>
            <li>Enter the model name you want to use</li>
            <li>Paste your API key (keep it secret!)</li>
            <li>Click "Save API Configuration"</li>
            <li>Click "Go to Chat" to start talking with AI personas</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</div>
