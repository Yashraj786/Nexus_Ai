<div class="container mx-auto max-w-4xl px-4 py-8">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold">Settings</h1>
    <%= link_to "← Back to Home", root_path, class: "btn btn-secondary" %>
  </div>

  <div class="card bg-base-200 shadow-lg">
    <div class="card-body">
      <h2 class="card-title text-2xl mb-6">API Key Configuration</h2>

      <% if @api_configured %>
        <div class="alert alert-success mb-6">
          <svg class="stroke-current shrink-0 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>API Configuration Active</span>
          <div class="text-sm mt-2">
            <p><strong>Provider:</strong> <%= @user.api_provider.upcase %></p>
            <p><strong>Model:</strong> <%= @user.api_model_name %></p>
            <p><strong>Configured:</strong> <%= @user.api_configured_at.strftime("%B %d, %Y at %I:%M %p") %></p>
          </div>
        </div>
      <% else %>
        <div class="alert alert-warning mb-6">
          <svg class="stroke-current shrink-0 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4v2m0 0v2m0-2h2m-2 0h-2"></path></svg>
          <span>No API Configuration</span>
          <p class="text-sm mt-2">Configure your API key to use all personas and features.</p>
        </div>
      <% end %>

      <div class="divider">Configure Your API</div>

      <%= form_with model: @user, local: true, url: settings_update_api_key_path, method: :patch, class: "space-y-4" do |f| %>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">API Provider *</span>
          </label>
          <select name="user[api_provider]" class="select select-bordered" required>
            <option value="">-- Select Provider --</option>
            <option value="openai" <%= 'selected' if @user.api_provider == 'openai' %>>OpenAI (GPT-4, GPT-3.5)</option>
            <option value="anthropic" <%= 'selected' if @user.api_provider == 'anthropic' %>>Anthropic (Claude)</option>
            <option value="gemini" <%= 'selected' if @user.api_provider == 'gemini' %>>Google Gemini</option>
            <option value="ollama" <%= 'selected' if @user.api_provider == 'ollama' %>>Ollama (Local)</option>
            <option value="custom" <%= 'selected' if @user.api_provider == 'custom' %>>Custom API</option>
          </select>
          <label class="label">
            <span class="label-text-alt">Choose your LLM provider</span>
          </label>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Model Name *</span>
          </label>
          <input 
            type="text" 
            name="user[api_model_name]" 
            placeholder="e.g., gpt-4, claude-3-opus, gemini-1.5-flash"
            value="<%= @user.api_model_name %>"
            class="input input-bordered" 
            required
          />
          <label class="label">
            <span class="label-text-alt">The specific model to use</span>
          </label>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">API Key *</span>
          </label>
          <input 
            type="password" 
            name="user[encrypted_api_key]" 
            placeholder="Your API key (leave blank to keep existing)"
            class="input input-bordered"
          />
          <label class="label">
            <span class="label-text-alt">Your API key is encrypted and stored securely</span>
          </label>
        </div>

        <div class="alert alert-info">
          <svg class="stroke-current shrink-0 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span>Provider Setup Guides</span>
          <ul class="text-sm mt-2 list-disc list-inside">
            <li><a href="https://platform.openai.com/account/api-keys" target="_blank" class="link">OpenAI API Keys</a></li>
            <li><a href="https://console.anthropic.com/" target="_blank" class="link">Anthropic Console</a></li>
            <li><a href="https://makersuite.google.com/app/apikey" target="_blank" class="link">Google Gemini API</a></li>
            <li><a href="https://ollama.ai" target="_blank" class="link">Ollama Setup Guide</a></li>
          </ul>
        </div>

        <div class="flex gap-4 mt-6">
          <button type="submit" class="btn btn-primary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            Save Configuration
          </button>
          
          <button type="button" class="btn btn-outline" data-test-api>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            Test Connection
          </button>

          <% if @api_configured %>
            <%= form_with url: settings_clear_api_key_path, method: :delete, local: true, style: "display:inline" do |f| %>
              <button type="submit" class="btn btn-error" onclick="return confirm('Are you sure?')">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Clear Configuration
              </button>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <div class="divider">FAQ</div>

      <div class="space-y-4">
        <div class="collapse collapse-arrow border border-base-300 bg-base-100">
          <input type="checkbox" />
          <div class="collapse-title font-semibold">Why do I need to provide my own API key?</div>
          <div class="collapse-content">
            <p>Nexus AI doesn't provide AI services. Instead, it lets you use any LLM provider you prefer. This gives you:
            <ul class="list-disc list-inside mt-2 space-y-1">
              <li>Full control over your API costs</li>
              <li>Choice of LLM providers and models</li>
              <li>Privacy - your data goes directly to your provider</li>
              <li>No vendor lock-in</li>
            </ul>
            </p>
          </div>
        </div>

        <div class="collapse collapse-arrow border border-base-300 bg-base-100">
          <input type="checkbox" />
          <div class="collapse-title font-semibold">Which provider should I choose?</div>
          <div class="collapse-content">
            <p>It depends on your needs:
            <ul class="list-disc list-inside mt-2 space-y-1">
              <li><strong>OpenAI:</strong> Best overall, most popular (GPT-4, GPT-3.5)</li>
              <li><strong>Anthropic:</strong> Privacy-focused, strong reasoning (Claude)</li>
              <li><strong>Google Gemini:</strong> Free tier available, good performance</li>
              <li><strong>Ollama:</strong> Free, runs locally on your machine (no cloud)</li>
              <li><strong>Custom:</strong> Use any API endpoint</li>
            </ul>
            </p>
          </div>
        </div>

        <div class="collapse collapse-arrow border border-base-300 bg-base-100">
          <input type="checkbox" />
          <div class="collapse-title font-semibold">Is my API key safe?</div>
          <div class="collapse-content">
            <p>Yes. Your API key is encrypted using Rails' built-in encryption before being stored in the database. Only you can see it, and it's never transmitted except to your chosen LLM provider.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.querySelector('[data-test-api]')?.addEventListener('click', async () => {
  const btn = event.target.closest('button');
  btn.disabled = true;
  btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Testing...';
  
  try {
    const response = await fetch('<%= settings_test_api_path %>', { method: 'POST' });
    const data = await response.json();
    
    if (data.success) {
      alert('✓ API connection successful!\n\n' + data.data);
    } else {
      alert('✗ Connection failed:\n\n' + data.error);
    }
  } catch (e) {
    alert('✗ Error testing API:\n\n' + e.message);
  }
  
  btn.disabled = false;
  btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> Test Connection';
});
</script>
