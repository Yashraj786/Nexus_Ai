<div class="h-full flex bg-white" data-controller="sidebar">
   <div class="flex-1 flex flex-col"
        data-controller="chat clipboard"
        data-chat-session-id-value="<%= @chat_session.id %>"
        data-clipboard-title-value="<%= @chat_session.title %>"
        data-clipboard-persona-value="<%= @chat_session.persona&.name %>"
        data-clipboard-restore-url-value="<%= chat_session_url(@chat_session) %>">

     <!-- Header -->
     <header class="flex-none h-14 border-b border-neutral-200 flex items-center justify-between px-4 sm:px-6 bg-white z-10">
       <div class="flex items-center gap-3 min-w-0">
         <div class="w-8 h-8 bg-neutral-100 rounded flex items-center justify-center flex-shrink-0">
           <i data-lucide="<%= @chat_session.persona&.icon || 'message-square' %>" class="w-4 h-4 text-neutral-700"></i>
         </div>
         <h1 class="text-sm font-semibold text-neutral-900 truncate">
           <%= @chat_session.persona&.name || 'Chat' %>
         </h1>
       </div>
       <div class="flex gap-1 flex-shrink-0">
         <button data-action="click->clipboard#copy" class="p-2 rounded hover:bg-neutral-100 text-neutral-600 hover:text-neutral-900 transition-colors" title="Save">
           <i data-lucide="copy" class="w-4 h-4"></i>
         </button>
         <%= link_to new_chat_session_feedback_path(@chat_session), class: "p-2 rounded hover:bg-neutral-100 text-neutral-600 hover:text-neutral-900 transition-colors", title: "Report" do %>
           <i data-lucide="alert-circle" class="w-4 h-4"></i>
         <% end %>
         <button data-action="click->chat#export" class="p-2 rounded hover:bg-neutral-100 text-neutral-600 hover:text-neutral-900 transition-colors" title="Export">
           <i data-lucide="download" class="w-4 h-4"></i>
         </button>
       </div>
     </header>

      <!-- Chat Area -->
      <div id="chat-container" class="flex-1 min-h-0 overflow-y-auto p-4 sm:p-6 scroll-smooth space-y-4 bg-white" data-chat-target="messages" data-clipboard-target="source">

        <% if @chat_session.messages.empty? %>
          <div class="h-full flex items-center justify-center">
            <div class="text-center max-w-sm">
              <div class="w-16 h-16 bg-neutral-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="<%= @chat_session.persona&.icon || 'message-square' %>" class="w-8 h-8 text-neutral-600"></i>
              </div>
              <h2 class="text-lg font-semibold text-neutral-900 mb-2">
                Start a conversation with <%= @chat_session.persona&.name || 'your assistant' %>
              </h2>
              <p class="text-sm text-neutral-600 mb-4">
                Ask questions, get advice, or explore topics together. <br />
                <%= @chat_session.persona&.description || 'Your AI assistant is ready to help.' %>
              </p>
            </div>
          </div>
        <% end %>

        <% @chat_session.messages.order(:created_at).each do |msg| %>
          <div class="message flex w-full <%= msg.user? ? 'justify-end' : 'justify-start' %>" data-role="<%= msg.role %>" data-content="<%= msg.content %>">
            <div class="max-w-[80%] p-3 text-sm leading-relaxed <%= msg.user? ? 'bg-black text-white rounded-2xl rounded-tr-sm' : 'bg-neutral-100 text-neutral-900 rounded-2xl rounded-tl-sm' %>">
              <div class="<%= msg.user? ? 'prose prose-sm max-w-none text-white prose-invert' : 'prose prose-sm max-w-none text-neutral-900' %>">
                 <%= markdown(msg.content) %> 
              </div>
            </div>
          </div>
        <% end %>

        <!-- Loading indicator -->
        <div id="loading-indicator" data-chat-target="loadingIndicator" class="hidden">
          <div class="flex w-full justify-start">
            <div class="flex items-center gap-2 bg-neutral-100 text-neutral-900 rounded-2xl rounded-tl-sm p-3">
              <div class="flex gap-1">
                <div class="w-2 h-2 bg-neutral-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-2 h-2 bg-neutral-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-neutral-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
              </div>
              <span class="text-xs text-neutral-600">AI is thinking...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="flex-none p-4 sm:p-6 bg-white border-t border-neutral-200">
        <div data-chat-target="retryBanner" class="hidden text-center text-xs text-neutral-600 mb-3 bg-neutral-100 p-2 rounded">
          The AI is processing your message...
        </div>
        <div id="form-errors" data-chat-target="formErrors" class="hidden mb-3 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
        <%= form_with(model: [@chat_session, Message.new], id: "message_form", class: "max-w-2xl mx-auto", data: { action: "submit->chat#sendMessage", chat_target: "form", chat_max_length_value: Message::MAX_CONTENT_LENGTH }) do |f| %>
         <div class="relative flex items-end gap-2 bg-white border border-neutral-300 p-3 rounded-lg focus-within:border-neutral-400 focus-within:ring-1 focus-within:ring-neutral-400 transition-all">
           <%= f.text_area :content, rows: 1, 
               data: { chat_target: "input" },
               maxlength: Message::MAX_CONTENT_LENGTH,
               class: "flex-1 bg-transparent border-none text-neutral-900 placeholder-neutral-400 p-2 min-h-[40px] max-h-[200px] resize-none focus:ring-0 text-sm",
               placeholder: "Message..." %>
           <button type="submit" class="bg-black text-white rounded p-2 hover:bg-neutral-800 transition-colors flex-shrink-0 flex items-center justify-center min-w-[40px] min-h-[40px]">
             <i data-lucide="send" class="w-4 h-4"></i>
           </button>
         </div>
       <% end %>
     </div>
   </div>

    <div class="w-64 border-l border-neutral-200 hidden lg:block bg-neutral-50" data-sidebar-target="sidebar">
      <%= render "session_insights" %>
    </div>
 </div>

<%= render "app_launcher_modal" %>
