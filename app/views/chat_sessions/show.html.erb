<div class="h-full flex" data-controller="sidebar">
  <div class="flex-1 flex flex-col"
       data-controller="chat clipboard"
       data-chat-session-id-value="<%= @chat_session.id %>"
       data-clipboard-title-value="<%= @chat_session.title %>"
       data-clipboard-persona-value="<%= @chat_session.persona&.name %>"
       data-clipboard-restore-url-value="<%= chat_session_url(@chat_session) %>">

    <!-- Header -->
    <header class="flex-none h-16 border-b border-gray-200 flex items-center justify-between px-6 bg-white/95 backdrop-blur-sm z-10">
      <div class="flex items-center gap-4">
        <i data-lucide="<%= @chat_session.persona&.icon || 'message-square' %>" class="w-6 h-6 text-orange-500"></i>
        <h1 class="text-xl font-rajdhani font-bold tracking-wide text-gray-900">
          <%= @chat_session.persona&.name&.upcase || 'GENERIC CHAT' %>
        </h1>
      </div>
      <div class="flex gap-3">
        <button data-action="click->clipboard#copy" class="action-chip">Save</button>
        <%= link_to "Report", new_chat_session_feedback_path(@chat_session), class: "action-chip" %>
        <button data-action="click->chat#export" class="action-chip">Export</button>
        <button data-action="app-launcher#toggle" class="action-chip">Apps</button>
        <button data-action="click->sidebar#toggle" class="lg:hidden action-chip">Info</button>
      </div>
    </header>

    <!-- Chat Area -->
    <div id="chat-container" class="flex-1 min-h-0 overflow-y-auto p-6 scroll-smooth space-y-4 bg-gradient-to-b from-white to-gray-50" data-chat-target="messages" data-clipboard-target="source">
      <% @chat_session.messages.order(:created_at).each do |msg| %>
        <div class="message flex w-full <%= msg.user? ? 'justify-end' : 'justify-start' %>" data-role="<%= msg.role %>" data-content="<%= msg.content %>">
          <div class="max-w-[85%] p-4 text-sm leading-relaxed rounded-xl 
            <%= msg.user? ? 
              'bg-gradient-to-br from-orange-500 to-orange-600 text-white shadow-lg hover:shadow-orange-300/50' : 
              'bg-white border-2 border-gray-200 text-gray-900 shadow-sm hover:shadow-md' %>">
            
            <div class="<%= msg.user? ? 'prose prose-sm max-w-none text-white' : 'prose prose-sm max-w-none text-gray-900' %>">
               <%= markdown(msg.content) %> 
               <% if msg.sanitized? %>
                 <span class="text-xs <%= msg.user? ? 'text-orange-100' : 'text-gray-500' %> ml-2" title="Content was sanitized for security or formatting."> (sanitized)</span>
               <% end %>
            </div>
            
          </div>
        </div>
      <% end %>
    </div>

    <!-- Input Area -->
    <div class="flex-none p-6 bg-white border-t border-gray-200">
      <div data-chat-target="retryBanner" class="hidden text-center text-sm text-amber-600 mb-3 bg-amber-50 p-2 rounded-lg">
        The AI is taking longer than usual; retrying safelyâ€¦
      </div>
      <%= form_with(model: [@chat_session, Message.new], class: "max-w-4xl mx-auto relative group", data: { action: "submit->chat#sendMessage", chat_target: "form", chat_max_length_value: Message::MAX_CONTENT_LENGTH }) do |f| %>
        
        <div class="relative flex items-end gap-3 bg-white p-3 rounded-xl border-2 border-gray-200 focus-within:border-orange-400 focus-within:shadow-lg focus-within:shadow-orange-200/50 transition-all">
          
          <%= f.text_area :content, rows: 1, 
              data: { chat_target: "input" },
              maxlength: Message::MAX_CONTENT_LENGTH,
              class: "flex-1 bg-transparent border-none text-gray-900 placeholder-gray-400 p-3 min-h-[50px] max-h-[200px] resize-none focus:ring-0 text-sm font-inter",
              placeholder: "Ask anything..." %>
              
          <button type="submit" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold rounded-lg p-3 transition-all hover:-translate-y-0.5 hover:shadow-lg hover:shadow-orange-300/50 active:translate-y-0">
            <i data-lucide="arrow-up" class="w-5 h-5"></i>
          </button>
          
        </div>
      <% end %>
    </div>
  </div>

  <div class="w-72 border-l border-gray-200 hidden lg:block bg-white" data-sidebar-target="sidebar">
    <%= render "session_insights" %>
  </div>
</div>

<%= render "app_launcher_modal" %>
